Image Detecting Plugin
======================

A prototype plugin for detecting images in a directory, written in Python using the watchdog library. 

# Building

Build a container image for the Image Detecting plugin using the following
command:

```
docker build --build-arg REL=0.4.0 -t tapis/image_detecting_plugin .
```

# Running with Motion

By default, an Image Detecting container starts up both the Linux Motion
package and the Image Detecting plugin. It requires the `privilged` flag
for access to the video device which it assumes to be `/dev/video0`. 
This is configured in the `motion.conf` file included in the repo. 
Eventually, we will update the installer to parameterize this value. 

```
docker run --privileged -it --rm tapis/image_detecting_plugin
```

If you want to save the files that are generated by Motion during 
an execution, simply add a host mount to `/var/lib/motion` in the 
container, i.e., 

```
docker run --privileged -v /path/on/host:/var/lib/motion -it --rm tapis/image_detecting_plugin
```

**Note:** You must ensure the host directory is world-writable (i.e., 
`chmod a+w`) or else the motion process will not be able to write to it. 

# Using the Compose File
For convenience for local testing, a docker-compose file is included in this directory. 
This compose file starts an engine and the Image Detecting Plugin in the default 
mode (i.e., with Motion running). Executing the command 

```
docker compose up
```
should start the containers. If the plugin is able to access your web cam (`/dev/video0`)
and motion is detected, then you should see logs indicating the plugin has generated 
new image events, e.g., 

```
image_detecting  | 2025-04-13 23:51:40 - New file detected: /var/lib/motion/20250413235140-00.jpg
image_detecting  | 2025-04-13 23:51:40 - Sending new image event with the following data: 
    image:/var/lib/motion/20250413235140-00.jpg; uuid:d50bd274-037e-5432-bed6-b259325a9607; format: JPEG
```
and you should also see logs indicating that the Image Receive plugin received these events, e.g., 

```
engine           | 2025-04-13T23:51:40.416177778Z DEBUG [ImageReceivePlugin] src/plugins/image_recv_plugin.rs:75 - 
engine           |   -> ImageReceivePlugin received event NewImageEvent
```

# Running Manually

You can also run the Image Detecting Plugin "manually" using 
a single docker container. 
You can configure the Python plugin to monitor a separate directory using
the DATA_MONITORING_PATH environment variable. 


If you want to manually test just the Python plugin, you can use a 
`sleep` entrypoint and mount a directory on your host to DATA_MONITORING_PATH in the container image:

```
docker run -e DATA_MONITORING_PATH=/data -v /path/on/host:/data --entrypoint=sleep --name detector -it --rm tapis/image_detecting_plugin 99999
```

Then, you can exec into the container and start the plugin:

```
docker exec -it detector bash

# from within the container
python -m image_detecting_plugin.py
```

With that in place, add files to the directory `/path/on/host`.
The plugin should detect them. 
